name: qora_workspace
description: A workspace for the Qora project.
repository: https://github.com/meragix/qora
publish_to: none

environment:
  sdk: ^3.9.0

dev_dependencies:
  melos: ^7.4.0

workspace:
  - packages/qora
  - packages/flutter_qora
  - packages/qora_devtools_extension
  - packages/qora_devtools_ui
  - packages/qora_devtools_shared

melos:
  command:
    version:
      # Generate commit links in package changelogs.
      linkToCommits: true
      workspaceChangelog: false
      message: "chore: release {version}"
    bootstrap:
      runPubGetInParallel: true

  scripts:
    # Analysis
    analyze:
      description: Run static analysis on all packages
      run: melos exec -- dart analyze .

    # Formatting
    format:
      description: Format all packages
      run: melos exec -- dart format .

    format:check:
      description: Check formatting
      run: melos exec -- dart format --output=none --set-exit-if-changed .

    # Testing
    test:
      description: Run all tests
      run: melos exec --fail-fast -- dart test --coverage=coverage

    test:coverage:
      description: Generate coverage report
      run: |
        melos exec -- dart test --coverage=coverage
        melos exec -- dart run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib

    # Build l'UI DevTools Web + copie vers le package noyau
    build:devtools:
      description: Build DevTools Web UI and copy to qora package
      run: |
        cd packages/qora_devtools_ui && flutter build web \
          --output build/devtools_extension &&
        cp -r build/devtools_extension \
          ../qora/extension/devtools/build

    # Publishing
    publish:check:
      description: Dry run publish
      run: melos exec -- dart pub publish --dry-run

    # Publication dans l'ordre correct des dépendances
    publish:
      run: melos exec --depends-on="qora_devtools_shared" -- dart pub publish

    # Vérification des imports circulaires
    check:imports:
      run: dart run import_lint:main

    # Version management
    version:
      description: Update version across packages
      run: melos version

    # Clean
    clean:
      description: Clean all packages
      run: melos exec -- dart pub cache clean
