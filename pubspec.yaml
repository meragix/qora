name: qora_workspace
description: A workspace for the Qora project.
repository: https://github.com/meragix/qora
publish_to: none

environment:
  sdk: ^3.9.0

dev_dependencies:
  melos: ^7.4.0

workspace:
  - packages/dart
  - packages/flutter
  - packages/hooks
  - packages/devtools/extension
  - packages/devtools/overlay
  - packages/devtools/shared
  - packages/devtools/ui

melos:
  command:
    version:
      independent: true
      linkToCommits: true
      workspaceChangelog: false
      message: "chore: release {version}"
    bootstrap:
      runPubGetInParallel: true

  scripts:

    # ── Format ────────────────────────────────────────────────────────
    format:
      description: Format all packages
      run: melos exec -- dart format .

    format:check:
      description: Check formatting on all packages (CI)
      run: melos exec -- dart format --output=none --set-exit-if-changed .

    # ── Analyze ───────────────────────────────────────────────────────
    analyze:
      description: Run static analysis on all packages
      run: melos exec -- dart analyze --fatal-infos .

    # ── Test ──────────────────────────────────────────────────────────
    test:dart:
      description: Run tests on pure Dart packages
      run: melos exec -- dart test --coverage=coverage
      packageFilters:
        flutter: false          # uniquement les packages sans Flutter SDK

    test:flutter:
      description: Run tests on Flutter packages
      run: melos exec -- flutter test --coverage
      packageFilters:
        flutter: true           # uniquement les packages avec Flutter SDK

    test:all:
      description: Run all tests (dart + flutter)
      run: |
        melos run test:dart
        melos run test:flutter

    # ── Coverage ──────────────────────────────────────────────────────
    coverage:
      description: Generate lcov coverage report
      run: |
        melos run test:all
        melos exec -- dart run coverage:format_coverage \
          --lcov --in=coverage --out=coverage/lcov.info --report-on=lib

    # ── Build DevTools UI ─────────────────────────────────────────────
    build:devtools:
      description: Build DevTools Web UI and copy into the extension package
      run: |
        cd packages/devtools/ui
        flutter build web --pwa-strategy=none --release --no-tree-shake-icons
        rm -rf ../extension/extension/devtools/build
        cp -r build/web ../extension/extension/devtools/build

    # ── Publish ───────────────────────────────────────────────────────
    publish:check:
      description: Dry-run publish on all packages
      run: melos exec -- dart pub publish --dry-run

    publish:
      description: Publish all packages in dependency order
      run: |
        melos exec --scope="qora" -- dart pub publish --force
        melos exec --scope="qora_devtools_shared" -- dart pub publish --force
        melos exec --scope="qora_devtools_extension" -- dart pub publish --force
        melos exec --scope="flutter_qora" -- dart pub publish --force
        melos exec --scope="qora_hooks" -- dart pub publish --force
        melos exec --scope="qora_devtools_overlay" -- dart pub publish --force

    # ── Clean ─────────────────────────────────────────────────────────
    clean:
      description: Clean all packages
      run: melos exec -- dart run build_runner clean