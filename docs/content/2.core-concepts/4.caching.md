---
title: Caching
description: Qora's cache is the engine behind instant data access. Learn how cache entries live, age, and are garbage collected — and how to control every aspect of it.
---

## How the Cache Works

Every query result is stored as a `CacheEntry` in an in-memory `QueryCache` keyed by the normalised query key. The cache drives:

- **Instant responses** — fresh data is returned without a network call
- **SWR** — stale data is returned immediately while fresh data is fetched in the background
- **Reactive updates** — every `CacheEntry` holds a broadcast stream; any state change reaches all active subscribers instantly

```text
fetchQuery(['users', 1])
  │
  ├─ Cache HIT  (fresh)  → return data immediately
  ├─ Cache HIT  (stale)  → return stale data + revalidate in background
  └─ Cache MISS          → fetch → store → return data
```

---

## Cache Entry Lifecycle

A `CacheEntry<T>` goes through the following stages:

```text
Created (Initial)
  │  fetchQuery / watchQuery triggered
  ▼
Loading → Success / Failure
  │  staleTime elapsed
  ▼
Stale (still in cache, accessible as previousData)
  │  last subscriber unsubscribes
  ▼
GC timer starts (= cacheTime)
  │  timer fires, no active subscribers
  ▼
Evicted (removed from cache)
```

A background eviction sweep also runs every minute to remove expired inactive entries.

---

## `staleTime` vs `cacheTime`

These two durations control completely different things:

| Property    | Default    | Controls                                              |
| ----------- | ---------- | ----------------------------------------------------- |
| `staleTime` | 0 (zero)   | When to trigger a background revalidation             |
| `cacheTime` | 5 minutes  | When to remove an unused entry from the cache         |

```dart [main.dart]
QoraOptions(
  staleTime: Duration(minutes: 5),   // data is fresh for 5 minutes
  cacheTime: Duration(minutes: 10),  // unused data stays in cache for 10 min
)
```

:::tip
`staleTime: Duration.zero` (the default) means data is **always** considered stale. Qora will still serve cached data immediately — it just also revalidates in the background every time.
:::

---

## `staleTime` in Detail

`staleTime` defines the "freshness window". During this window, data is returned from cache without any network activity:

```dart [main.dart]
// staleTime: 5 minutes

// t = 0:00 → fetch triggers, Success stored
// t = 0:01 → fetchQuery → Cache HIT (fresh) — no network call
// t = 5:01 → fetchQuery → Cache HIT (stale) — returns cached data + revalidates
// t = 5:01 → network request fires in background
// t = 5:02 → Success updated, stream subscribers notified
```

Set a long `staleTime` for data that rarely changes:

```dart [main.dart]
// Configuration data — valid for 1 hour
options: QoraOptions(staleTime: Duration(hours: 1)),

// User profile — valid for 10 minutes
options: QoraOptions(staleTime: Duration(minutes: 10)),

// Live prices — always stale (default)
options: QoraOptions(staleTime: Duration.zero),
```

---

## `cacheTime` in Detail

`cacheTime` determines how long **inactive** data lingers in cache after all subscribers leave. It preserves data for fast re-navigation:

```dart [main.dart]
// User navigates away → last subscriber cancels → GC timer starts
// User navigates back within cacheTime → entry still in cache → instant display
// User navigates back after cacheTime → entry evicted → full fetch required
```

```dart [main.dart]
// Posts list — keep in cache for 2 minutes after leaving the page
options: QoraOptions(cacheTime: Duration(minutes: 2)),
```

:::warning
Setting `cacheTime: Duration.zero` means the entry is removed as soon as all subscribers leave. The next visit will always start from `Initial`. This is correct for sensitive data (e.g. session-specific data after logout).
:::

---

## LRU Eviction

When `maxCacheSize` is set on `QoraClientConfig`, the cache enforces a limit using an LRU (Least Recently Used) strategy:

- The entry that has been **accessed least recently** and has **no active subscribers** is evicted to make room
- Active entries (with subscribers) are **never forcibly evicted**

```dart [main.dart]
final client = QoraClient(
  config: QoraClientConfig(maxCacheSize: 100),
);
```

Each call to `fetchQuery`, `watchQuery`, or `getQueryData` updates `lastAccessedAt`, keeping entries alive in the LRU ranking.

---

## Manual Cache Control

### Read the cache

```dart [main.dart]
// Get just the data (null if not Success / no previousData)
final user = client.getQueryData<User>(['users', userId]);

// Get the full state
final state = client.getQueryState<User>(['users', userId]);

// Inspect all cached keys
for (final key in client.cachedKeys) {
  print(key);
}
```

### Write to the cache

```dart [main.dart]
// Inject data directly — all active watchQuery streams are notified
client.setQueryData<User>(['users', userId], updatedUser);

// Roll back to a previous snapshot
final snapshot = client.getQueryData<User>(['users', userId]);
client.setQueryData(['users', userId], optimisticUser);

try {
  await api.updateUser(userId, payload);
} catch (_) {
  client.restoreQueryData(['users', userId], snapshot);
}
```

### Invalidate (mark stale)

```dart [main.dart]
// Single key — active streams transition to Loading immediately
client.invalidate(['users', userId]);

// Multiple keys via predicate
client.invalidateWhere((key) => key.firstOrNull == 'users');
```

### Remove and clear

```dart [main.dart]
// Remove a single entry (GC is immediate)
client.removeQuery(['users', userId]);

// Wipe the entire cache (e.g. on logout)
client.clear();
```

---

## `onCacheEvict` Callback

React to cache evictions for logging or storage sync:

```dart [main.dart]
final client = QoraClient(
  config: QoraClientConfig(
    onCacheEvict: (key) {
      analytics.track('cache_evict', {'key': key.toString()});
    },
  ),
);
```

---

## Debug Snapshot

```dart [main.dart]
print(client.debugInfo());
// {
//   total_queries: 12,
//   active_queries: 3,
//   inactive_queries: 9,
//   non_success_queries: 1,
//   pending_requests: 2,
//   max_size: 100,
//   keys: [['users', 1], ['posts'], ...]
// }
```

---

## Global vs Per-query Config

`cacheTime` and `staleTime` can be set globally via `QoraClientConfig.defaultOptions` and overridden per query:

```dart [main.dart]
final client = QoraClient(
  config: QoraClientConfig(
    defaultOptions: QoraOptions(
      staleTime: Duration(minutes: 5),  // global default
      cacheTime: Duration(minutes: 10),
    ),
  ),
);

// This query overrides staleTime only
await client.fetchQuery<Config>(
  key: ['config'],
  fetcher: api.getConfig,
  options: QoraOptions(staleTime: Duration(hours: 1)),
  // cacheTime still inherits 10 minutes from global
);
```

---

## Next Steps

- [Stale-While-Revalidate](./stale-while-revalidate.md) — How background revalidation works
- [Deduplication](./deduplication.md) — One network request for many callers
- [QoraClientConfig API](/api-reference/qora-client-config) — Full configuration reference
