name: CI

on:
  pull_request:
    # branches: [main]
  push:
    # branches: [main]

jobs:
  # ── Dart packages ────────────────────────────────────────────────
  qora:
    uses: ./.github/workflows/_dart_package.yml
    with:
      package: packages/dart
    secrets: inherit

  qora_devtools_shared:
    uses: ./.github/workflows/_dart_package.yml
    with:
      package: packages/devtools/shared
    needs: qora
    secrets: inherit

  qora_devtools_extension:
    uses: ./.github/workflows/_dart_package.yml
    with:
      package: packages/devtools/extension
    needs: qora_devtools_shared
    secrets: inherit

  # ── Flutter packages ─────────────────────────────────────────────
  flutter_qora:
    uses: ./.github/workflows/_flutter_package.yml
    with:
      package: packages/flutter
    needs: qora
    secrets: inherit

  qora_hooks:
    uses: ./.github/workflows/_flutter_package.yml
    with:
      package: packages/hooks
    needs: flutter_qora
    secrets: inherit

  qora_devtools_overlay:
    uses: ./.github/workflows/_flutter_package.yml
    with:
      package: packages/devtools/overlay
    needs: qora_devtools_shared
    secrets: inherit

  qora_devtools_ui:
    uses: ./.github/workflows/_flutter_package.yml
    with:
      package: packages/devtools/ui
    needs: qora_devtools_shared
    secrets: inherit

  # ── Gate final — tous les jobs doivent passer ────────────────────
  # Ce job est référencé comme "required status check" dans les
  # branch protection rules de GitHub. Un seul job à configurer
  # au lieu de 7.
  all-green:
    name: All packages CI passed
    runs-on: ubuntu-latest
    needs:
      - qora
      - qora_devtools_shared
      - qora_devtools_extension
      - flutter_qora
      - qora_hooks
      - qora_devtools_overlay
      - qora_devtools_ui
    steps:
      - run: echo "All packages passed"
